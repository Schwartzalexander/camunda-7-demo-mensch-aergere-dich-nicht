<!doctype html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Mensch Ã¤rgere dich nicht â€“ BPMN Demo</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 24px; }
        .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        button { padding: 10px 14px; cursor: pointer; }
        .board { display: grid; grid-template-columns: repeat(30, 44px); gap: 8px; margin-top: 18px; }
        .cell { width: 44px; height: 44px; border: 2px solid #333; border-radius: 10px; display:flex; align-items:center; justify-content:center; position: relative; }
        .cell.goal { border-style: dashed; }
        .token { width: 18px; height: 18px; border-radius: 50%; background: #333; position:absolute; }
        .meta { margin-top: 16px; }
        code { background: #f3f3f3; padding: 2px 6px; border-radius: 6px; }
    </style>
</head>
<body>
<h1>Mensch Ã¤rgere dich nicht (Solo, 1 Figur)</h1>

<div class="row">
    <button id="startBtn">Neues Spiel starten</button>
    <button id="rollBtn">WÃ¼rfeln</button>
    <div>ProcessInstanceId: <code id="pid" th:text="${processInstanceId}"> </code></div>
    <div id="status"></div>
</div>

<div class="board" id="board"></div>

<div class="meta" id="meta"></div>

<script>
    const GOAL_POS = 30;
    const POLL_INTERVAL_MS = 1000;

    function ensurePoller() {
      if (!window.__statePoller) {
        window.__statePoller = setInterval(fetchState, POLL_INTERVAL_MS);
      }
    }

    function renderBoard(state) {
      const board = document.getElementById('board');
      board.innerHTML = '';
      for (let i = 1; i <= GOAL_POS; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell' + (i === GOAL_POS ? ' goal' : '');
        cell.textContent = i;
        if (state.position === i) {
          const token = document.createElement('div');
          token.className = 'token';
          cell.appendChild(token);
        }
        board.appendChild(cell);
      }
    }

    function renderMeta(state) {
      const meta = document.getElementById('meta');
      meta.innerHTML = `
        <div>inStartArea: <code>${state.inStartArea}</code> | attempts: <code>${state.attempts}</code> | position: <code>${state.position}</code> | inGoal: <code>${state.inGoal}</code></div>
        <div>Startbereich-Wurf: <code>${state.lastDice1 ?? '-'}</code> + <code>${state.lastDice2 ?? '-'}</code> (Pasch=<code>${state.isPasch ?? '-'}</code>)</div>
        <div>Normal-Wurf: <code>${state.lastDice ?? '-'}</code> (wouldEnterGoal=<code>${state.wouldEnterGoal ?? '-'}</code>, exactGoal=<code>${state.exactGoal ?? '-'}</code>)</div>
        <p>Hinweis: Der Prozess wartet auf einen User Task (<code>Task_RollDice_StartArea</code> oder <code>Task_RollDice_Normal</code>). Der WÃ¼rfeln-Button sucht den offenen Task per REST und completed ihn mit zufÃ¤lligen WÃ¼rfeln, danach lÃ¤uft der Prozess weiter.</p>
        <p>Camunda Webapps: <a href="/camunda/app/welcome/default/#!/login" target="_blank">Cockpit/Tasklist</a> (demo/demo)</p>
      `;
    }

    async function fetchState() {
      const pid = document.getElementById('pid').textContent.trim();
      if (!pid) return;
      const res = await fetch(`/api/state?processInstanceId=${encodeURIComponent(pid)}`);
      if (res.status === 404) {
        document.getElementById('status').textContent = 'Prozess beendet oder nicht gefunden. Starte ein neues Spiel.';
        clearInterval(window.__statePoller);
        window.__statePoller = null;
        return;
      }
      if (!res.ok) return;
      const state = await res.json();
      document.getElementById('status').textContent = state.inGoal ? 'Im Ziel ðŸŽ‰' : 'LÃ¤uft...';
      renderBoard(state);
      renderMeta(state);
    }

    document.getElementById('startBtn').addEventListener('click', async () => {
      document.getElementById('status').textContent = 'Starting...';
      const res = await fetch('/api/start', { method: 'POST' });
      const data = await res.json();
      document.getElementById('pid').textContent = data.processInstanceId;
      document.getElementById('status').textContent = 'Running';
      ensurePoller();
      await fetchState();
    });

    document.getElementById('rollBtn').addEventListener('click', async () => {
      const pid = document.getElementById('pid').textContent.trim();
      if (!pid) {
        document.getElementById('status').textContent = 'Bitte zuerst ein Spiel starten.';
        return;
      }
      document.getElementById('status').textContent = 'WÃ¼rfeln...';
      const res = await fetch(`/api/roll?processInstanceId=${encodeURIComponent(pid)}`, { method: 'POST' });
      if (res.status === 404) {
        document.getElementById('status').textContent = 'Prozess nicht gefunden. Starte ein neues Spiel.';
        return;
      }
      if (res.status === 409) {
        const data = await res.json();
        document.getElementById('status').textContent = data.message ?? 'Kein wÃ¼rfelbarer Task gefunden.';
        return;
      }
      if (!res.ok) {
        document.getElementById('status').textContent = 'Fehler beim WÃ¼rfeln.';
        return;
      }
      const state = await res.json();
      document.getElementById('status').textContent = state.inGoal ? 'Im Ziel ðŸŽ‰' : 'GewÃ¼rfelt.';
      renderBoard(state);
      renderMeta(state);
    });

    // initial render
    fetchState();
    ensurePoller();
</script>
</body>
</html>
