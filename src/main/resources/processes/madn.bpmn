<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" id="Definitions_MaDn_Multiplayer" targetNamespace="http://example.com/mensch-aerger-dich-nicht" exporter="Camunda Modeler" exporterVersion="5.42.0">
  <bpmn:process id="Game_MaDn_Multiplayer" name="Mensch ärgere dich nicht – Multiplayer" isExecutable="true">
    <bpmn:startEvent id="StartEvent_GameStarted" name="Spiel gestartet">
      <bpmn:outgoing>Flow_Start_To_Init</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:serviceTask id="Task_InitGameState" name="InitGameState" camunda:class="com.example.madn.camunda.delegate.InitGameStateDelegate">
      <bpmn:incoming>Flow_Start_To_Init</bpmn:incoming>
      <bpmn:outgoing>Flow_Init_To_SelectPlayer</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:sequenceFlow id="Flow_Start_To_Init" sourceRef="StartEvent_GameStarted" targetRef="Task_InitGameState" />
    <bpmn:subProcess id="SubProcess_TurnLoop" name="Turn Loop">
      <bpmn:incoming>Flow_Init_To_SelectPlayer</bpmn:incoming>
      <bpmn:outgoing>Flow_TurnLoop_To_EndCheck</bpmn:outgoing>
      <bpmn:startEvent id="StartEvent_TurnLoop">
        <bpmn:outgoing>Flow_Turn_Start_To_SelectPlayer</bpmn:outgoing>
      </bpmn:startEvent>
      <bpmn:serviceTask id="Task_SelectCurrentPlayer" name="Current Player setzen" camunda:class="com.example.madn.camunda.delegate.SelectCurrentPlayerDelegate">
        <bpmn:incoming>Flow_Turn_Start_To_SelectPlayer</bpmn:incoming>
        <bpmn:outgoing>Flow_SelectPlayer_To_RollDice</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:userTask id="Task_RollDice" name="Würfeln" camunda:assignee="${currentPlayerId}">
        <bpmn:incoming>Flow_SelectPlayer_To_RollDice</bpmn:incoming>
        <bpmn:outgoing>Flow_RollDice_To_ChoosePiece</bpmn:outgoing>
      </bpmn:userTask>
      <bpmn:userTask id="Task_ChoosePiece" name="Figur auswählen" camunda:assignee="${currentPlayerId}">
        <bpmn:incoming>Flow_RollDice_To_ChoosePiece</bpmn:incoming>
        <bpmn:outgoing>Flow_ChoosePiece_To_ExecuteTurn</bpmn:outgoing>
      </bpmn:userTask>
      <bpmn:callActivity id="Call_ExecuteTurn" name="Zug ausführen" calledElement="Process_ExecuteTurn">
        <bpmn:incoming>Flow_ChoosePiece_To_ExecuteTurn</bpmn:incoming>
        <bpmn:outgoing>Flow_ExecuteTurn_To_ApplyKicks</bpmn:outgoing>
        <bpmn:extensionElements>
          <camunda:in source="currentPlayerId" target="currentPlayerId" />
          <camunda:in source="chosenPieceId" target="chosenPieceId" />
          <camunda:in source="boardState" target="boardState" />
          <camunda:in source="isPasch" target="isPasch" />
        </bpmn:extensionElements>
      </bpmn:callActivity>
      <bpmn:serviceTask id="Task_ApplyKicks" name="Schmeißen" camunda:class="com.example.madn.camunda.delegate.ApplyKicksDelegate">
        <bpmn:incoming>Flow_ExecuteTurn_To_ApplyKicks</bpmn:incoming>
        <bpmn:outgoing>Flow_ApplyKicks_To_CheckWin</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:serviceTask id="Task_CheckWin" name="Sieg prüfen" camunda:class="com.example.madn.camunda.delegate.CheckWinDelegate">
        <bpmn:incoming>Flow_ApplyKicks_To_CheckWin</bpmn:incoming>
        <bpmn:outgoing>Flow_CheckWin_To_WinnerGateway</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:exclusiveGateway id="Gateway_Winner" name="Winner?">
        <bpmn:incoming>Flow_CheckWin_To_WinnerGateway</bpmn:incoming>
        <bpmn:outgoing>Flow_Winner_No</bpmn:outgoing>
        <bpmn:outgoing>Flow_Winner_Yes</bpmn:outgoing>
      </bpmn:exclusiveGateway>
      <bpmn:serviceTask id="Task_AdvancePlayer" name="Nächster Spieler" camunda:class="com.example.madn.camunda.delegate.AdvancePlayerDelegate">
        <bpmn:incoming>Flow_Winner_No</bpmn:incoming>
        <bpmn:outgoing>Flow_AdvancePlayer_To_Loop</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:sequenceFlow id="Flow_Turn_Start_To_SelectPlayer" sourceRef="StartEvent_TurnLoop" targetRef="Task_SelectCurrentPlayer" />
      <bpmn:sequenceFlow id="Flow_SelectPlayer_To_RollDice" sourceRef="Task_SelectCurrentPlayer" targetRef="Task_RollDice" />
      <bpmn:sequenceFlow id="Flow_RollDice_To_ChoosePiece" sourceRef="Task_RollDice" targetRef="Task_ChoosePiece" />
      <bpmn:sequenceFlow id="Flow_ChoosePiece_To_ExecuteTurn" sourceRef="Task_ChoosePiece" targetRef="Call_ExecuteTurn" />
      <bpmn:sequenceFlow id="Flow_ExecuteTurn_To_ApplyKicks" sourceRef="Call_ExecuteTurn" targetRef="Task_ApplyKicks" />
      <bpmn:sequenceFlow id="Flow_ApplyKicks_To_CheckWin" sourceRef="Task_ApplyKicks" targetRef="Task_CheckWin" />
      <bpmn:sequenceFlow id="Flow_CheckWin_To_WinnerGateway" sourceRef="Task_CheckWin" targetRef="Gateway_Winner" />
      <bpmn:sequenceFlow id="Flow_Winner_No" sourceRef="Gateway_Winner" targetRef="Task_AdvancePlayer">
        <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${winnerPlayerId == null}</bpmn:conditionExpression>
      </bpmn:sequenceFlow>
      <bpmn:endEvent id="EndEvent_TurnLoop">
        <bpmn:incoming>Flow_Winner_Yes</bpmn:incoming>
      </bpmn:endEvent>
      <bpmn:sequenceFlow id="Flow_Winner_Yes" sourceRef="Gateway_Winner" targetRef="EndEvent_TurnLoop">
        <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${winnerPlayerId != null}</bpmn:conditionExpression>
      </bpmn:sequenceFlow>
      <bpmn:sequenceFlow id="Flow_AdvancePlayer_To_Loop" sourceRef="Task_AdvancePlayer" targetRef="Task_SelectCurrentPlayer" />
    </bpmn:subProcess>
    <bpmn:sequenceFlow id="Flow_Init_To_SelectPlayer" sourceRef="Task_InitGameState" targetRef="SubProcess_TurnLoop" />
    <bpmn:endEvent id="EndEvent_GameFinished" name="Spiel beendet">
      <bpmn:incoming>Flow_TurnLoop_To_EndCheck</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_TurnLoop_To_EndCheck" sourceRef="SubProcess_TurnLoop" targetRef="EndEvent_GameFinished" />
  </bpmn:process>

  <bpmn:process id="Process_ExecuteTurn" name="ExecuteTurn" isExecutable="true">
    <bpmn:startEvent id="StartEvent_ExecuteTurn">
      <bpmn:outgoing>Flow_LoadPiece</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:serviceTask id="Task_LoadPieceState" name="Figur laden" camunda:class="com.example.madn.camunda.delegate.LoadPieceStateDelegate">
      <bpmn:incoming>Flow_LoadPiece</bpmn:incoming>
      <bpmn:outgoing>Flow_Load_To_CheckGoal</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:exclusiveGateway id="Gateway_InGoal" name="Schon im Ziel?">
      <bpmn:incoming>Flow_Load_To_CheckGoal</bpmn:incoming>
      <bpmn:outgoing>Flow_InGoal_Yes</bpmn:outgoing>
      <bpmn:outgoing>Flow_InGoal_No</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:serviceTask id="Task_NoMoveGoal" name="Kein Zug möglich" camunda:class="com.example.madn.camunda.delegate.NoMoveDelegate">
      <bpmn:incoming>Flow_InGoal_Yes</bpmn:incoming>
      <bpmn:outgoing>Flow_NoMoveGoal_To_End</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:exclusiveGateway id="Gateway_AtHome" name="Figur zuhause?">
      <bpmn:incoming>Flow_InGoal_No</bpmn:incoming>
      <bpmn:outgoing>Flow_AtHome_Yes</bpmn:outgoing>
      <bpmn:outgoing>Flow_AtHome_No</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:exclusiveGateway id="Gateway_CanEnterBoard" name="Pasch?">
      <bpmn:incoming>Flow_AtHome_Yes</bpmn:incoming>
      <bpmn:outgoing>Flow_CanEnter_Yes</bpmn:outgoing>
      <bpmn:outgoing>Flow_CanEnter_No</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:serviceTask id="Task_EnterBoard" name="Aufs Startfeld" camunda:class="com.example.madn.camunda.delegate.EnterBoardDelegate">
      <bpmn:incoming>Flow_CanEnter_Yes</bpmn:incoming>
      <bpmn:outgoing>Flow_Enter_To_End</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="Task_NoMoveHome" name="Kein Zug möglich" camunda:class="com.example.madn.camunda.delegate.NoMoveDelegate">
      <bpmn:incoming>Flow_CanEnter_No</bpmn:incoming>
      <bpmn:outgoing>Flow_NoMoveHome_To_End</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="Task_ComputeTarget" name="Zug berechnen" camunda:class="com.example.madn.camunda.delegate.ComputeTargetDelegate">
      <bpmn:incoming>Flow_AtHome_No</bpmn:incoming>
      <bpmn:outgoing>Flow_Compute_To_End</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:endEvent id="EndEvent_ExecuteTurn">
      <bpmn:incoming>Flow_NoMoveGoal_To_End</bpmn:incoming>
      <bpmn:incoming>Flow_Enter_To_End</bpmn:incoming>
      <bpmn:incoming>Flow_NoMoveHome_To_End</bpmn:incoming>
      <bpmn:incoming>Flow_Compute_To_End</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_LoadPiece" sourceRef="StartEvent_ExecuteTurn" targetRef="Task_LoadPieceState" />
    <bpmn:sequenceFlow id="Flow_Load_To_CheckGoal" sourceRef="Task_LoadPieceState" targetRef="Gateway_InGoal" />
    <bpmn:sequenceFlow id="Flow_InGoal_Yes" sourceRef="Gateway_InGoal" targetRef="Task_NoMoveGoal">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${pieceStatus == 'GOAL'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_InGoal_No" sourceRef="Gateway_InGoal" targetRef="Gateway_AtHome">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${pieceStatus != 'GOAL'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_NoMoveGoal_To_End" sourceRef="Task_NoMoveGoal" targetRef="EndEvent_ExecuteTurn" />
    <bpmn:sequenceFlow id="Flow_AtHome_Yes" sourceRef="Gateway_AtHome" targetRef="Gateway_CanEnterBoard">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${pieceStatus == 'HOME'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_AtHome_No" sourceRef="Gateway_AtHome" targetRef="Task_ComputeTarget">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${pieceStatus == 'BOARD'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_CanEnter_Yes" sourceRef="Gateway_CanEnterBoard" targetRef="Task_EnterBoard">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${isPasch == true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_CanEnter_No" sourceRef="Gateway_CanEnterBoard" targetRef="Task_NoMoveHome">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${isPasch != true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_Enter_To_End" sourceRef="Task_EnterBoard" targetRef="EndEvent_ExecuteTurn" />
    <bpmn:sequenceFlow id="Flow_NoMoveHome_To_End" sourceRef="Task_NoMoveHome" targetRef="EndEvent_ExecuteTurn" />
    <bpmn:sequenceFlow id="Flow_Compute_To_End" sourceRef="Task_ComputeTarget" targetRef="EndEvent_ExecuteTurn" />
  </bpmn:process>
</bpmn:definitions>
